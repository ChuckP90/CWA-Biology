<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CWA-Biology</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Inter', sans-serif; }
    html { scroll-behavior: smooth; }
    section { min-height: 100vh; padding: 5rem 1rem; }
    .error-msg { color: #dc2626; font-size: 0.875rem; }
    .tab { display: none; }
    .tab.active { display: block; }
    .admin-shell { display: grid; grid-template-columns: 260px 1fr; gap: 1.25rem; }
    .masked { font-family: monospace; }
    .dropzone { border: 2px dashed #e5e7eb; border-radius: 0.75rem; padding: 1rem; text-align:center; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Announcement Banner (Admin-controlled) -->
  <div id="globalAnnouncement" class="hidden bg-yellow-100 text-yellow-900 px-6 py-3 text-center"></div>

  <header id="top-header" class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
          <span class="text-white font-bold text-lg">B</span>
        </div>
        <h1 id="siteName" class="text-2xl font-bold text-green-700">CWA-Biology</h1>
      </div>
      <nav class="hidden md:flex space-x-6 items-center">
        <a href="#home" class="nav-link text-gray-700 hover:text-green-600 font-medium">Home</a>
        <a href="#library" class="nav-link text-gray-700 hover:text-green-600 font-medium">Library</a>
        <a href="#exercises" class="nav-link text-gray-700 hover:text-green-600 font-medium">Exercises</a>
        <a href="#assignments" class="nav-link text-gray-700 hover:text-green-600 font-medium">Assignments</a>
        <a href="#progress" class="nav-link text-gray-700 hover:text-green-600 font-medium">Progress</a>
        <a href="#teacher-dashboard" class="nav-link text-gray-700 hover:text-green-600 font-medium">Teacher Dashboard</a>
        <a href="#student-dashboard" class="nav-link text-gray-700 hover:text-green-600 font-medium">Student Dashboard</a>
        <button id="loginBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Login</button>
        <button id="registerBtn" class="border-2 border-green-600 text-green-600 px-4 py-2 rounded-lg hover:bg-green-600 hover:text-white">Register</button>
        <button id="adminLoginBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Admin</button>
      </nav>
    </div>
  </header>

  <!-- Home Section -->
  <section id="home" class="relative flex items-center justify-center bg-gray-800 text-white">
    <div class="absolute inset-0">
      <img src="https://image2url.com/images/1756192024345-f9e28db4-2b09-4491-8922-12b7a732ea2c.jpg" alt="Biology Lab" class="w-full h-full object-cover" />
      <div class="absolute inset-0 bg-black bg-opacity-40"></div>
    </div>
    <div class="relative z-10 text-center px-6">
      <h2 class="text-3xl md:text-5xl font-bold mb-4">Welcome to <span class="text-green-400">CWA-Biology</span></h2>
      <p class="text-lg md:text-xl max-w-2xl mb-8">Interactive Learning Platform for Students & Teachers</p>
      <div class="space-x-4">
        <a href="#library" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium">Explore Library</a>
        <a href="#exercises" class="border-2 border-white hover:bg-white hover:text-gray-800 px-6 py-3 rounded-lg font-medium">Start Practicing</a>
      </div>
    </div>
  </section>

  <!-- Library Section -->
  <section id="library" data-controlled="library" class="bg-gray-100">
    <h2 class="text-3xl font-bold text-center mb-8">üìö Library</h2>
    <div class="max-w-6xl mx-auto">
      <div class="mb-4 flex items-center gap-3">
        <input id="librarySearch" type="text" placeholder="Search resources..." class="w-full md:w-1/2 border rounded-lg px-4 py-2"/>
        <select id="libraryFilter" class="border rounded-lg px-3 py-2">
          <option value="all">All</option>
          <option value="article">Articles</option>
          <option value="video">Videos</option>
        </select>
      </div>
      <div id="libraryList" class="grid md:grid-cols-3 gap-6"></div>
      <p id="libraryEmpty" class="hidden text-center text-gray-500">No resources yet. Admin can add some from Admin ‚Üí Library.</p>
    </div>
  </section>

  <!-- Exercises Section -->
  <section id="exercises" data-controlled="exercises" class="bg-white">
    <h2 class="text-3xl font-bold text-center mb-8">‚úèÔ∏è Exercises</h2>
    <div id="exerciseList" class="max-w-5xl mx-auto grid md:grid-cols-2 gap-6"></div>
    <p id="exerciseEmpty" class="hidden text-center text-gray-500">No exercises yet. Admin can add some from Admin ‚Üí Quizzes.</p>
  </section>

  <!-- Assignments Section -->
  <section id="assignments" data-controlled="assignments" class="bg-gray-100">
    <h2 class="text-3xl font-bold text-center mb-8">üìù Assignments</h2>
    <p class="text-center text-gray-600">Assignments will be listed here.</p>
  </section>

  <!-- Progress Section -->
  <section id="progress" data-controlled="progress" class="bg-white">
    <h2 class="text-3xl font-bold text-center mb-8">üìä Progress Tracking</h2>
    <p class="text-center text-gray-600">Progress tracking information will be shown here.</p>
  </section>

  <!-- Teacher Dashboard Section (placeholder‚Äîexisting functionality assumed) -->
  <section id="teacher-dashboard" data-controlled="teacher" class="bg-gray-100">
    <h2 class="text-3xl font-bold text-center mb-8">üë©‚Äçüè´ Teacher Dashboard</h2>
    <div class="max-w-5xl mx-auto grid md:grid-cols-2 gap-8">
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-xl font-semibold mb-3 text-green-700">Manage Classes</h3>
        <form id="tCreateClass" class="space-y-3">
          <input type="text" name="title" placeholder="Class Name" class="w-full border rounded-lg px-4 py-2" required>
          <textarea name="desc" placeholder="Class Description" class="w-full border rounded-lg px-4 py-2"></textarea>
          <button class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Add Class</button>
        </form>
        <div id="tClassList" class="mt-4 space-y-3"></div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-xl font-semibold mb-3 text-green-700">Tasks & Feedback</h3>
        <form id="tAddTask" class="space-y-3">
          <input type="text" name="title" placeholder="Task Title" class="w-full border rounded-lg px-4 py-2" required>
          <textarea name="details" placeholder="Task Details" class="w-full border rounded-lg px-4 py-2"></textarea>
          <button class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Add Task</button>
        </form>
        <div id="tTaskList" class="mt-4 space-y-3"></div>
      </div>
    </div>
  </section>

  <!-- Student Dashboard Section (placeholder‚Äîexisting functionality assumed) -->
  <section id="student-dashboard" data-controlled="student" class="bg-white">
    <h2 class="text-3xl font-bold text-center mb-8">üë®‚Äçüéì Student Dashboard</h2>
    <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-8">
      <div class="bg-gray-100 p-6 rounded-xl shadow">
        <h3 class="text-xl font-semibold mb-4 text-green-700">Join a Class</h3>
        <form id="sJoinClass" class="space-y-3">
          <input type="text" name="code" placeholder="Class Code" class="w-full border rounded-lg px-4 py-2" required>
          <button class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Join Class</button>
        </form>
        <div id="sClassList" class="mt-4 space-y-3"></div>
      </div>
      <div class="bg-gray-100 p-6 rounded-xl shadow">
        <h3 class="text-xl font-semibold mb-4 text-green-700">Your Tasks & Progress</h3>
        <div id="sTaskList" class="space-y-3"></div>
      </div>
    </div>
  </section>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow w-full max-w-md p-6">
      <h3 class="text-2xl font-bold mb-4 text-center">Login</h3>
      <form id="loginForm" class="space-y-4">
        <input type="email" id="loginEmail" placeholder="Email" class="w-full border rounded-lg px-4 py-2" required>
        <input type="password" id="loginPassword" placeholder="Password" class="w-full border rounded-lg px-4 py-2" required>
        <p id="loginError" class="error-msg hidden"></p>
        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Login</button>
      </form>
      <button id="closeLogin" class="mt-4 w-full text-center text-red-600 hover:underline">Close</button>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow w-full max-w-md p-6">
      <h3 class="text-2xl font-bold mb-4 text-center">Register</h3>
      <form id="registerForm" class="space-y-4">
        <select id="userRole" class="w-full border rounded-lg px-4 py-2" required>
          <option value="">Select Role</option>
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
        </select>
        <input type="text" id="fullName" placeholder="Full Name" class="w-full border rounded-lg px-4 py-2" required>
        <input type="email" id="registerEmail" placeholder="Email" class="w-full border rounded-lg px-4 py-2" required>
        <input type="password" id="registerPassword" placeholder="Password" class="w-full border rounded-lg px-4 py-2" required>
        <input type="password" id="confirmPassword" placeholder="Confirm Password" class="w-full border rounded-lg px-4 py-2" required>
        <p id="registerError" class="error-msg hidden"></p>
        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Register</button>
      </form>
      <button id="closeRegister" class="mt-4 w-full text-center text-red-600 hover:underline">Close</button>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow w-full max-w-md p-6">
      <h3 class="text-2xl font-bold mb-4 text-center text-red-600">Admin Login</h3>
      <form id="adminLoginForm" class="space-y-4">
        <input type="text" id="adminUsername" placeholder="Username" class="w-full border rounded-lg px-4 py-2" required>
        <input type="password" id="adminPassword" placeholder="Password" class="w-full border rounded-lg px-4 py-2" required>
        <p id="adminLoginError" class="error-msg hidden"></p>
        <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Login</button>
      </form>
      <button id="closeAdminLogin" class="mt-4 w-full text-center text-red-600 hover:underline">Close</button>
    </div>
  </div>

  <!-- Confirm Modal (generic) -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow w-full max-w-sm p-6">
      <h3 id="confirmTitle" class="text-xl font-semibold mb-2">Confirm</h3>
      <p id="confirmMessage" class="text-gray-700 mb-4"></p>
      <div class="flex justify-end gap-3">
        <button id="confirmCancel" class="px-4 py-2 rounded-lg border">Cancel</button>
        <button id="confirmOk" class="px-4 py-2 rounded-lg bg-red-600 text-white">OK</button>
      </div>
    </div>
  </div>

  <!-- Admin Dashboard (with sidebar + tabs) -->
  <section id="admin-dashboard" class="bg-gray-100 hidden">
    <div class="max-w-7xl mx-auto py-8">
      <h2 class="text-3xl font-bold text-center mb-8 text-gray-800">üõ†Ô∏è Admin Dashboard</h2>
      <div class="admin-shell">
        <!-- Sidebar -->
        <aside class="bg-white rounded-xl shadow p-4 h-fit">
          <nav class="space-y-2">
            <button class="admin-tab-btn w-full text-left px-4 py-2 rounded-lg bg-red-600 text-white" data-tab="units">Units</button>
            <button class="admin-tab-btn w-full text-left px-4 py-2 rounded-lg bg-gray-200" data-tab="library">Library</button>
            <button class="admin-tab-btn w-full text-left px-4 py-2 rounded-lg bg-gray-200" data-tab="quizzes">Quizzes</button>
            <button class="admin-tab-btn w-full text-left px-4 py-2 rounded-lg bg-gray-200" data-tab="users">Users</button>
            <button class="admin-tab-btn w-full text-left px-4 py-2 rounded-lg bg-gray-200" data-tab="analytics">Analytics</button>
            <button class="admin-tab-btn w-full text-left px-4 py-2 rounded-lg bg-gray-200" data-tab="settings">Site Settings</button>
          </nav>
          <div class="mt-6 border-t pt-4 text-sm text-gray-500">
            <p id="adminSessionInfo">Session active</p>
            <button id="adminLogout" class="mt-2 text-red-600 hover:underline">Log out</button>
          </div>
        </aside>

        <!-- Main Panel -->
        <div class="space-y-6">
          <!-- Units Tab -->
          <div id="tab-units" class="tab active bg-white p-6 rounded-xl shadow">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-red-600">Manage Units</h3>
              <input id="unitSearch" type="text" placeholder="Search units..." class="border rounded-lg px-3 py-2"/>
            </div>
            <form id="unitForm" class="grid md:grid-cols-2 gap-3 mb-4">
              <input type="text" name="title" placeholder="Unit Title" class="border rounded-lg px-4 py-2" required>
              <input type="text" name="code" placeholder="Unit Code (e.g., BIO-101)" class="border rounded-lg px-4 py-2">
              <textarea name="desc" placeholder="Unit Description" class="md:col-span-2 border rounded-lg px-4 py-2"></textarea>
              <button class="md:col-span-2 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Add Unit</button>
            </form>
            <div id="unitList" class="divide-y"></div>
            <p id="unitEmpty" class="hidden text-gray-500">No units yet.</p>
          </div>

          <!-- Library Tab -->
          <div id="tab-library" class="tab bg-white p-6 rounded-xl shadow">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-red-600">Manage Library</h3>
              <input id="adminLibrarySearch" type="text" placeholder="Search library..." class="border rounded-lg px-3 py-2"/>
            </div>
            <form id="libraryForm" class="grid md:grid-cols-2 gap-3 mb-4">
              <input type="text" name="title" placeholder="Resource Title" class="border rounded-lg px-4 py-2" required>
              <select name="type" class="border rounded-lg px-3 py-2">
                <option value="article">Article</option>
                <option value="video">Video</option>
              </select>
              <input type="url" name="url" placeholder="Resource URL (optional)" class="border rounded-lg px-4 py-2 md:col-span-2">
              <div id="libDrop" class="dropzone md:col-span-2">Drag & Drop file here or click to select<input type="file" name="file" class="hidden"/></div>
              <textarea name="desc" placeholder="Short Description" class="border rounded-lg px-4 py-2 md:col-span-2"></textarea>
              <button class="md:col-span-2 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Upload / Add</button>
            </form>
            <div id="adminLibraryList" class="divide-y"></div>
            <p id="adminLibraryEmpty" class="hidden text-gray-500">No resources yet.</p>
          </div>

          <!-- Quizzes Tab -->
          <div id="tab-quizzes" class="tab bg-white p-6 rounded-xl shadow">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-red-600">Manage Quizzes & Exercises</h3>
              <input id="quizSearch" type="text" placeholder="Search quizzes..." class="border rounded-lg px-3 py-2"/>
            </div>
            <form id="quizForm" class="grid md:grid-cols-2 gap-3 mb-4">
              <input type="text" name="title" placeholder="Quiz Title" class="border rounded-lg px-4 py-2" required>
              <select name="category" class="border rounded-lg px-3 py-2">
                <option value="general">General</option>
                <option value="cell-bio">Cell Biology</option>
                <option value="genetics">Genetics</option>
                <option value="ecology">Ecology</option>
              </select>
              <input type="url" name="url" placeholder="Quiz/Exercise URL (optional)" class="border rounded-lg px-4 py-2 md:col-span-2">
              <div id="quizDrop" class="dropzone md:col-span-2">Drag & Drop file here or click to select<input type="file" name="file" class="hidden"/></div>
              <textarea name="desc" placeholder="Short Description" class="border rounded-lg px-4 py-2 md:col-span-2"></textarea>
              <button class="md:col-span-2 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Create / Upload</button>
            </form>
            <div id="quizList" class="divide-y"></div>
            <p id="quizEmpty" class="hidden text-gray-500">No quizzes yet.</p>
          </div>

          <!-- Users Tab -->
          <div id="tab-users" class="tab bg-white p-6 rounded-xl shadow">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-semibold text-red-600">Manage Users</h3>
              <input id="userSearch" type="text" placeholder="Search users..." class="border rounded-lg px-3 py-2"/>
            </div>
            <div id="userList" class="divide-y"></div>
            <p id="userEmpty" class="hidden text-gray-500">No users yet.</p>
          </div>

          <!-- Analytics Tab -->
          <div id="tab-analytics" class="tab bg-white p-6 rounded-xl shadow">
            <h3 class="text-xl font-semibold text-red-600 mb-4">Platform Analytics</h3>
            <div class="grid md:grid-cols-4 gap-4 mb-6">
              <div class="bg-gray-100 p-4 rounded-lg text-center"><div class="text-3xl font-bold" id="statStudents">0</div><div class="text-gray-600">Students</div></div>
              <div class="bg-gray-100 p-4 rounded-lg text-center"><div class="text-3xl font-bold" id="statTeachers">0</div><div class="text-gray-600">Teachers</div></div>
              <div class="bg-gray-100 p-4 rounded-lg text-center"><div class="text-3xl font-bold" id="statClasses">0</div><div class="text-gray-600">Classes</div></div>
              <div class="bg-gray-100 p-4 rounded-lg text-center"><div class="text-3xl font-bold" id="statResources">0</div><div class="text-gray-600">Resources</div></div>
            </div>
            <div class="bg-gray-100 p-6 rounded-lg text-center text-gray-600">Charts can be plugged in later (e.g., usage over time).</div>
          </div>

          <!-- Settings Tab -->
          <div id="tab-settings" class="tab bg-white p-6 rounded-xl shadow">
            <h3 class="text-xl font-semibold text-red-600 mb-4">Site Settings</h3>
            <form id="settingsForm" class="space-y-6">
              <div>
                <label class="block font-medium mb-2">Site Title</label>
                <input id="settingSiteName" type="text" class="border rounded-lg px-4 py-2 w-full" placeholder="CWA-Biology"/>
              </div>
              <div>
                <label class="block font-medium mb-2">Global Announcement</label>
                <textarea id="settingAnnouncement" class="border rounded-lg px-4 py-2 w-full" placeholder="Short message shown at the top of the site"></textarea>
              </div>
              <div>
                <p class="font-medium mb-2">Toggle Sections</p>
                <div class="grid md:grid-cols-3 gap-3">
                  <label class="flex items-center gap-2"><input type="checkbox" class="setting-toggle" data-target="library"> Library</label>
                  <label class="flex items-center gap-2"><input type="checkbox" class="setting-toggle" data-target="exercises"> Exercises</label>
                  <label class="flex items-center gap-2"><input type="checkbox" class="setting-toggle" data-target="assignments"> Assignments</label>
                  <label class="flex items-center gap-2"><input type="checkbox" class="setting-toggle" data-target="progress"> Progress</label>
                  <label class="flex items-center gap-2"><input type="checkbox" class="setting-toggle" data-target="teacher"> Teacher Dashboard</label>
                  <label class="flex items-center gap-2"><input type="checkbox" class="setting-toggle" data-target="student"> Student Dashboard</label>
                </div>
              </div>
              <div class="flex justify-end gap-3">
                <button type="button" id="settingsReset" class="px-4 py-2 rounded-lg border">Reset</button>
                <button class="px-4 py-2 rounded-lg bg-red-600 text-white">Save Settings</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
  (function(){
    // ===== Utilities & Local Storage Helpers =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const saveLS = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const loadLS = (k,def=null)=>{ try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? def; }catch{ return def; } };

    // ===== Smooth scroll for in-canvas nav =====
    const header = document.getElementById('top-header');
    const headerOffset = header ? header.offsetHeight : 0;
    function scrollToSection(id){ const el = document.getElementById(id); if(!el) return; const y = el.getBoundingClientRect().top + window.scrollY - headerOffset - 8; window.scrollTo({ top:y, behavior:'smooth' }); }
    $$("a.nav-link[href^='#']").forEach(a=>a.addEventListener('click',e=>{ e.preventDefault(); scrollToSection(a.getAttribute('href').slice(1)); }));

    // ===== Auth: Register & Login (mock) =====
    const loginBtn = $('#loginBtn'); const registerBtn = $('#registerBtn');
    const loginModal = $('#loginModal'); const registerModal = $('#registerModal');
    $('#closeLogin').addEventListener('click', ()=>loginModal.classList.add('hidden'));
    $('#closeRegister').addEventListener('click', ()=>registerModal.classList.add('hidden'));
    loginBtn.addEventListener('click', ()=>loginModal.classList.remove('hidden'));
    registerBtn.addEventListener('click', ()=>registerModal.classList.remove('hidden'));

    const allowedTeacherTLDs = [".edu", ".cn", ".uk", ".us", ".org", ".net", ".edu.cn", ".edu.uk", ".edu.tr", ".edu.au", ".ac.uk", ".ac.cn"]; // extendable

    const users = loadLS('users', []); // {name,email,role,status}
    function maskEmail(email){ const [u,d] = email.split('@'); if(!d) return email; return `${u.slice(0,2)}***@${d}`; }

    $('#registerForm').addEventListener('submit', e=>{
      e.preventDefault();
      const role = $('#userRole').value; const name = $('#fullName').value.trim();
      const email = $('#registerEmail').value.trim(); const pass = $('#registerPassword').value; const cpass = $('#confirmPassword').value;
      const err = $('#registerError');
      if(!role){ err.textContent = 'Please select a role.'; err.classList.remove('hidden'); return; }
      if(role==='teacher'){
        const ok = allowedTeacherTLDs.some(tld=> email.toLowerCase().endsWith(tld));
        if(!ok){ err.textContent = 'Teachers must use a school email (accepted academic TLDs).'; err.classList.remove('hidden'); return; }
      }
      if(pass !== cpass){ err.textContent = 'Passwords do not match.'; err.classList.remove('hidden'); return; }
      err.classList.add('hidden');
      users.push({ name, email, role, status:'active' });
      saveLS('users', users);
      alert('Registration successful! You can log in now.');
      registerModal.classList.add('hidden');
      renderUsers();
      updateAnalytics();
    });

    $('#loginForm').addEventListener('submit', e=>{
      e.preventDefault();
      const email = $('#loginEmail').value.trim(); const pass = $('#loginPassword').value;
      const err = $('#loginError');
      if(!email || !pass){ err.textContent = 'Please enter email and password.'; err.classList.remove('hidden'); return; }
      const u = users.find(x=>x.email===email);
      if(!u){ err.textContent = 'User not found. Please register.'; err.classList.remove('hidden'); return; }
      if(u.status==='suspended'){ err.textContent = 'Account suspended. Contact admin.'; err.classList.remove('hidden'); return; }
      err.classList.add('hidden');
      alert(`Welcome ${u.name}!`);
      loginModal.classList.add('hidden');
    });

    // ===== Teacher/Student simple lists (mock) =====
    const classes = loadLS('classes', []); // {id,title,desc,code}
    const tasks = loadLS('tasks', []); // {id,title,details}

    $('#tCreateClass').addEventListener('submit', e=>{
      e.preventDefault();
      const fd = new FormData(e.target); const title = fd.get('title'); const desc = fd.get('desc')||'';
      const code = Math.random().toString(36).slice(2,8).toUpperCase();
      const c = { id: crypto.randomUUID(), title, desc, code };
      classes.push(c); saveLS('classes', classes); e.target.reset(); renderTeacherClasses(); updateAnalytics();
    });
    function renderTeacherClasses(){ const wrap = $('#tClassList'); wrap.innerHTML = classes.map(c=>`<div class='border rounded-lg p-3 flex items-center justify-between'><div><div class='font-semibold'>${c.title}</div><div class='text-sm text-gray-500'>Code: ${c.code}</div></div><button data-id='${c.id}' class='del-class text-red-600 hover:underline'>Delete</button></div>`).join('');
      wrap.querySelectorAll('.del-class').forEach(btn=>btn.addEventListener('click',()=>confirmAction('Delete Class', 'Are you sure you want to delete this class?', ()=>{ const idx = classes.findIndex(x=>x.id===btn.dataset.id); if(idx>-1){ classes.splice(idx,1); saveLS('classes', classes); renderTeacherClasses(); updateAnalytics(); }})));
    }
    renderTeacherClasses();

    $('#tAddTask').addEventListener('submit', e=>{
      e.preventDefault(); const fd = new FormData(e.target); const title = fd.get('title'); const details = fd.get('details')||'';
      const t = { id: crypto.randomUUID(), title, details }; tasks.push(t); saveLS('tasks', tasks); e.target.reset(); renderTeacherTasks();
    });
    function renderTeacherTasks(){ const wrap = $('#tTaskList'); wrap.innerHTML = tasks.map(t=>`<div class='border rounded-lg p-3 flex items-center justify-between'><div><div class='font-semibold'>${t.title}</div><div class='text-sm text-gray-500 line-clamp-2'>${t.details}</div></div><button data-id='${t.id}' class='del-task text-red-600 hover:underline'>Delete</button></div>`).join('');
      wrap.querySelectorAll('.del-task').forEach(btn=>btn.addEventListener('click',()=>confirmAction('Delete Task', 'This cannot be undone.', ()=>{ const i = tasks.findIndex(x=>x.id===btn.dataset.id); if(i>-1){ tasks.splice(i,1); saveLS('tasks', tasks); renderTeacherTasks(); }})));
    }
    renderTeacherTasks();

    // Student join & view tasks
    const joined = loadLS('joined', []); // class ids
    $('#sJoinClass').addEventListener('submit', e=>{
      e.preventDefault(); const code = new FormData(e.target).get('code').trim().toUpperCase();
      const found = classes.find(c=>c.code===code);
      if(!found){ alert('Class not found'); return; }
      if(!joined.includes(found.id)){ joined.push(found.id); saveLS('joined', joined); }
      renderStudentClasses();
    });
    function renderStudentClasses(){ const wrap = $('#sClassList'); const list = classes.filter(c=>joined.includes(c.id)); wrap.innerHTML = list.length? list.map(c=>`<div class='border rounded-lg p-3'><div class='font-semibold'>${c.title}</div><div class='text-sm text-gray-500'>${c.desc||''}</div></div>`).join('') : '<p class="text-gray-500">Not joined any class yet.</p>'; $('#sTaskList').innerHTML = tasks.map(t=>`<div class='border rounded-lg p-3'><div class='font-semibold'>${t.title}</div><div class='text-sm text-gray-500'>${t.details}</div></div>`).join(''); }
    renderStudentClasses();

    // ===== Admin Login & Session =====
    const adminLoginBtn = $('#adminLoginBtn'); const adminLoginModal = $('#adminLoginModal'); const closeAdminLogin = $('#closeAdminLogin');
    const adminDashboard = $('#admin-dashboard'); const adminSessionInfo = $('#adminSessionInfo'); const adminLogout = $('#adminLogout');
    let adminActive = false; let adminTimer = null; const ADMIN_TIMEOUT_MS = 5*60*1000; // 5 minutes demo

    function startAdminTimer(){ clearTimeout(adminTimer); adminTimer = setTimeout(()=>{ adminActive=false; adminDashboard.classList.add('hidden'); alert('Admin session timed out due to inactivity.'); }, ADMIN_TIMEOUT_MS); adminSessionInfo.textContent = 'Session active (auto-logout in 5 min)'; }
    ['click','keydown','mousemove'].forEach(evt=>document.addEventListener(evt, ()=>{ if(adminActive) startAdminTimer(); }, {passive:true}));

    adminLoginBtn.addEventListener('click', ()=>adminLoginModal.classList.remove('hidden'));
    closeAdminLogin.addEventListener('click', ()=>adminLoginModal.classList.add('hidden'));

    $('#adminLoginForm').addEventListener('submit', e=>{
      e.preventDefault(); const u = $('#adminUsername').value.trim(); const p = $('#adminPassword').value; const err = $('#adminLoginError');
      if(u==='Chagri90' && p==='CWA2025BIO'){ err.classList.add('hidden'); adminLoginModal.classList.add('hidden'); adminDashboard.classList.remove('hidden'); adminActive=true; startAdminTimer(); alert('Welcome Admin!'); renderUsers(); renderAllAdminViews(); applySettingsUI(); updateAnalytics(); } else { err.textContent='Invalid admin credentials'; err.classList.remove('hidden'); }
    });

    adminLogout.addEventListener('click', ()=>{ adminActive=false; adminDashboard.classList.add('hidden'); clearTimeout(adminTimer); });

    // ===== Admin Tabs =====
    const tabButtons = $$('.admin-tab-btn'); const tabs = $$('.tab');
    tabButtons.forEach(btn=>btn.addEventListener('click', ()=>{
      const tab = btn.getAttribute('data-tab');
      tabs.forEach(t=>t.classList.remove('active'));
      $(`#tab-${tab}`).classList.add('active');
      tabButtons.forEach(b=>{ b.classList.remove('bg-red-600','text-white'); b.classList.add('bg-gray-200'); });
      btn.classList.add('bg-red-600','text-white'); btn.classList.remove('bg-gray-200');
    }));

    // ===== Units CRUD (Admin) =====
    const units = loadLS('units', []); // {id,title,code,desc}
    $('#unitForm').addEventListener('submit', e=>{
      e.preventDefault(); const fd = new FormData(e.target);
      const unit = { id: crypto.randomUUID(), title: fd.get('title').trim(), code: (fd.get('code')||'').trim(), desc: (fd.get('desc')||'').trim() };
      units.push(unit); saveLS('units', units); e.target.reset(); renderUnits();
    });
    function renderUnits(){ const list = $('#unitList'); const q = ($('#unitSearch').value||'').toLowerCase(); const view = units.filter(u=>[u.title,u.code,u.desc].join(' ').toLowerCase().includes(q));
      if(!view.length){ $('#unitEmpty').classList.remove('hidden'); list.innerHTML=''; } else { $('#unitEmpty').classList.add('hidden'); list.innerHTML = view.map(u=>`<div class='py-3 flex items-start justify-between gap-3'><div><div class='font-semibold'>${u.title} ${u.code?`<span class="text-gray-400">(${u.code})</span>`:''}</div><div class='text-sm text-gray-600'>${u.desc||''}</div></div><div class='flex gap-2'><button class='edit-unit text-blue-600' data-id='${u.id}'>Edit</button><button class='delete-unit text-red-600' data-id='${u.id}'>Delete</button></div></div>`).join(''); }
      list.querySelectorAll('.delete-unit').forEach(b=>b.addEventListener('click',()=>confirmAction('Delete Unit','This will remove the unit.', ()=>{ const i = units.findIndex(x=>x.id===b.dataset.id); if(i>-1){ units.splice(i,1); saveLS('units', units); renderUnits(); }})));
      list.querySelectorAll('.edit-unit').forEach(b=>b.addEventListener('click',()=>{ const u = units.find(x=>x.id===b.dataset.id); if(!u) return; const title = prompt('Edit title', u.title)||u.title; const code = prompt('Edit code', u.code)||u.code; const desc = prompt('Edit description', u.desc)||u.desc; Object.assign(u,{title,code,desc}); saveLS('units', units); renderUnits(); }));
      renderPublicFromUnits();
    }
    $('#unitSearch').addEventListener('input', renderUnits);
    renderUnits();
    function renderPublicFromUnits(){ // populate library/exercises placeholders if wanted
      // no-op for now but left for future linking
    }

    // ===== Library CRUD (Admin) & Public View =====
    const resources = loadLS('resources', []); // {id,title,type,url,desc,filename}
    function bindDropzone(zoneId){ const box = $(zoneId); const input = box.querySelector('input[type=file]');
      box.addEventListener('click', ()=>input.click());
      ;['dragenter','dragover'].forEach(eName=> box.addEventListener(eName, e=>{ e.preventDefault(); box.classList.add('bg-gray-50'); }));
      ;['dragleave','drop'].forEach(eName=> box.addEventListener(eName, e=>{ e.preventDefault(); box.classList.remove('bg-gray-50'); }));
      box.addEventListener('drop', e=>{ input.files = e.dataTransfer.files; });
      return input;
    }
    const libFileInput = bindDropzone('#libDrop');

    $('#libraryForm').addEventListener('submit', e=>{
      e.preventDefault(); const fd = new FormData(e.target);
      const r = { id: crypto.randomUUID(), title: fd.get('title').trim(), type: fd.get('type'), url: (fd.get('url')||'').trim(), desc: (fd.get('desc')||'').trim(), filename: (fd.get('file') && fd.get('file').name) || '' };
      resources.push(r); saveLS('resources', resources); e.target.reset(); renderAdminLibrary(); renderPublicLibrary(); updateAnalytics();
    });

    function renderAdminLibrary(){ const list = $('#adminLibraryList'); const q = ($('#adminLibrarySearch').value||'').toLowerCase(); const view = resources.filter(r=>[r.title,r.type,r.desc,r.url,r.filename].join(' ').toLowerCase().includes(q));
      if(!view.length){ $('#adminLibraryEmpty').classList.remove('hidden'); list.innerHTML=''; }
      else { $('#adminLibraryEmpty').classList.add('hidden'); list.innerHTML = view.map(r=>`<div class='py-3 flex items-start justify-between gap-3'><div><div class='font-semibold'>${r.title} <span class='text-gray-400'>[${r.type}]</span></div><div class='text-sm text-gray-600'>${r.desc||''}</div><div class='text-xs text-gray-500'>${r.url?`URL: ${r.url}`:''} ${r.filename?`File: ${r.filename}`:''}</div></div><div class='flex gap-2'><button class='edit-res text-blue-600' data-id='${r.id}'>Edit</button><button class='del-res text-red-600' data-id='${r.id}'>Delete</button></div></div>`).join(''); }
      list.querySelectorAll('.del-res').forEach(b=>b.addEventListener('click',()=>confirmAction('Delete Resource','Remove from library?', ()=>{ const i=resources.findIndex(x=>x.id===b.dataset.id); if(i>-1){ resources.splice(i,1); saveLS('resources', resources); renderAdminLibrary(); renderPublicLibrary(); updateAnalytics(); }})));
      list.querySelectorAll('.edit-res').forEach(b=>b.addEventListener('click',()=>{ const r=resources.find(x=>x.id===b.dataset.id); if(!r) return; const title=prompt('Edit title', r.title)||r.title; const type=prompt('Edit type (article/video)', r.type)||r.type; const url=prompt('Edit URL', r.url)||r.url; const desc=prompt('Edit description', r.desc)||r.desc; Object.assign(r,{title,type,url,desc}); saveLS('resources', resources); renderAdminLibrary(); renderPublicLibrary(); }));
    }
    $('#adminLibrarySearch').addEventListener('input', renderAdminLibrary);

    function renderPublicLibrary(){ const list = $('#libraryList'); const empty = $('#libraryEmpty'); const q=($('#librarySearch').value||'').toLowerCase(); const f=$('#libraryFilter').value;
      const view = resources.filter(r=> (f==='all'||r.type===f) && [r.title,r.desc,r.type].join(' ').toLowerCase().includes(q));
      if(!view.length){ empty.classList.remove('hidden'); list.innerHTML=''; }
      else { empty.classList.add('hidden'); list.innerHTML = view.map(r=>`<div class='bg-white p-4 rounded-xl shadow'><h3 class='text-lg font-semibold mb-1 text-green-700'>${r.title}</h3><p class='text-gray-600 mb-2'>${r.desc||''}</p>${r.url?`<a class='text-blue-600 hover:underline' href='${r.url}' target='_blank' rel='noopener'>Open</a>`:''}</div>`).join(''); }
      updateAnalytics();
    }
    $('#librarySearch').addEventListener('input', renderPublicLibrary);
    $('#libraryFilter').addEventListener('change', renderPublicLibrary);

    // ===== Quizzes CRUD (Admin) & Public Exercises =====
    const quizzes = loadLS('quizzes', []); // {id,title,category,url,desc,filename}
    const quizFileInput = bindDropzone('#quizDrop');
    $('#quizForm').addEventListener('submit', e=>{
      e.preventDefault(); const fd = new FormData(e.target);
      const q = { id: crypto.randomUUID(), title: fd.get('title').trim(), category: fd.get('category'), url: (fd.get('url')||'').trim(), desc: (fd.get('desc')||'').trim(), filename: (fd.get('file') && fd.get('file').name) || '' };
      quizzes.push(q); saveLS('quizzes', quizzes); e.target.reset(); renderQuizzes(); renderExercises();
    });
    function renderQuizzes(){ const list = $('#quizList'); const qtxt = ($('#quizSearch').value||'').toLowerCase(); const view = quizzes.filter(q=>[q.title,q.category,q.desc,q.url,q.filename].join(' ').toLowerCase().includes(qtxt));
      if(!view.length){ $('#quizEmpty').classList.remove('hidden'); list.innerHTML=''; }
      else { $('#quizEmpty').classList.add('hidden'); list.innerHTML = view.map(q=>`<div class='py-3 flex items-start justify-between gap-3'><div><div class='font-semibold'>${q.title} <span class='text-gray-400'>[${q.category}]</span></div><div class='text-sm text-gray-600'>${q.desc||''}</div><div class='text-xs text-gray-500'>${q.url?`URL: ${q.url}`:''} ${q.filename?`File: ${q.filename}`:''}</div></div><div class='flex gap-2'><button class='edit-quiz text-blue-600' data-id='${q.id}'>Edit</button><button class='del-quiz text-red-600' data-id='${q.id}'>Delete</button></div></div>`).join(''); }
      list.querySelectorAll('.del-quiz').forEach(b=>b.addEventListener('click',()=>confirmAction('Delete Quiz','Remove this quiz?', ()=>{ const i=quizzes.findIndex(x=>x.id===b.dataset.id); if(i>-1){ quizzes.splice(i,1); saveLS('quizzes', quizzes); renderQuizzes(); renderExercises(); }})));
      list.querySelectorAll('.edit-quiz').forEach(b=>b.addEventListener('click',()=>{ const q=quizzes.find(x=>x.id===b.dataset.id); if(!q) return; const title=prompt('Edit title', q.title)||q.title; const category=prompt('Edit category', q.category)||q.category; const url=prompt('Edit URL', q.url)||q.url; const desc=prompt('Edit description', q.desc)||q.desc; Object.assign(q,{title,category,url,desc}); saveLS('quizzes', quizzes); renderQuizzes(); renderExercises(); }));
    }
    $('#quizSearch').addEventListener('input', renderQuizzes);

    function renderExercises(){ const list = $('#exerciseList'); const empty = $('#exerciseEmpty');
      if(!quizzes.length){ empty.classList.remove('hidden'); list.innerHTML=''; }
      else { empty.classList.add('hidden'); list.innerHTML = quizzes.map(q=>`<div class='border rounded-xl p-4'><h4 class='font-semibold mb-1'>${q.title}</h4><p class='text-sm text-gray-600 mb-2'>${q.desc||''}</p>${q.url?`<a class='text-blue-600 hover:underline' href='${q.url}' target='_blank' rel='noopener'>Open</a>`:''}</div>`).join(''); }
      updateAnalytics();
    }

    // ===== Users (Admin) =====
    function renderUsers(){ const list = $('#userList'); const q = ($('#userSearch').value||'').toLowerCase(); const view = users.filter(u=>[u.name,u.email,u.role,u.status].join(' ').toLowerCase().includes(q));
      if(!view.length){ $('#userEmpty').classList.remove('hidden'); list.innerHTML=''; }
      else { $('#userEmpty').classList.add('hidden'); list.innerHTML = view.map(u=>`<div class='py-3 flex items-center justify-between'><div><div class='font-semibold'>${u.name} <span class='text-gray-400'>[${u.role}]</span></div><div class='text-sm text-gray-600 masked'>${maskEmail(u.email)}</div><div class='text-xs text-gray-500'>Status: ${u.status}</div></div><div class='flex gap-3 items-center'><button class='assist-user text-green-700' data-email='${u.email}'>Assist</button><button class='toggle-user text-${u.status==='active'?'red':'green'}-700' data-email='${u.email}'>${u.status==='active'?'Suspend':'Activate'}</button></div></div>`).join(''); }
      list.querySelectorAll('.toggle-user').forEach(b=>b.addEventListener('click',()=>{ const u = users.find(x=>x.email===b.dataset.email); if(!u) return; const to = u.status==='active'?'suspend':'activate'; confirmAction(`${to==='suspend'?'Suspend':'Activate'} User`, `Are you sure you want to ${to} this account?`, ()=>{ u.status = (u.status==='active')?'suspended':'active'; saveLS('users', users); renderUsers(); }); }));
      list.querySelectorAll('.assist-user').forEach(b=>b.addEventListener('click',()=>{ alert(`Assist ticket opened for ${b.dataset.email}`); }));
      updateAnalytics();
    }
    $('#userSearch').addEventListener('input', renderUsers);

    // ===== Confirm Modal Utility =====
    function confirmAction(title, message, onOk){ const modal=$('#confirmModal'); $('#confirmTitle').textContent=title; $('#confirmMessage').textContent=message; modal.classList.remove('hidden'); const ok=$('#confirmOk'); const cancel=$('#confirmCancel'); function cleanup(){ ok.replaceWith(ok.cloneNode(true)); cancel.replaceWith(cancel.cloneNode(true)); $('#confirmOk').addEventListener('click', ()=>{ modal.classList.add('hidden'); onOk&&onOk(); }); $('#confirmCancel').addEventListener('click', ()=> modal.classList.add('hidden')); }
      cleanup(); }

    // ===== Settings (Admin) =====
    const settings = loadLS('settings', { siteName:'CWA-Biology', announcement:'', toggles:{ library:true, exercises:true, assignments:true, progress:true, teacher:true, student:true } });
    function applySettingsUI(){ $('#settingSiteName').value = settings.siteName; $('#settingAnnouncement').value = settings.announcement; $$('.setting-toggle').forEach(inp=> inp.checked = !!settings.toggles[inp.dataset.target]); applySettingsPublic(); }
    function applySettingsPublic(){ // title
      $('#siteName').textContent = settings.siteName || 'CWA-Biology';
      const banner = $('#globalAnnouncement'); banner.textContent = settings.announcement||''; banner.classList.toggle('hidden', !settings.announcement);
      // toggles on sections
      $$('[data-controlled]').forEach(sec=>{ const key = sec.getAttribute('data-controlled'); const show = settings.toggles[key] !== false; sec.classList.toggle('hidden', !show); });
    }
    $('#settingsForm').addEventListener('submit', e=>{ e.preventDefault(); settings.siteName = $('#settingSiteName').value.trim() || 'CWA-Biology'; settings.announcement = $('#settingAnnouncement').value.trim(); settings.toggles = settings.toggles || {}; $$('.setting-toggle').forEach(inp=> settings.toggles[inp.dataset.target] = inp.checked); saveLS('settings', settings); applySettingsPublic(); alert('Settings saved'); });
    $('#settingsReset').addEventListener('click', ()=>{ localStorage.removeItem('settings'); Object.assign(settings, { siteName:'CWA-Biology', announcement:'', toggles:{ library:true, exercises:true, assignments:true, progress:true, teacher:true, student:true } }); applySettingsUI(); alert('Settings reset'); });

    // ===== Rendering boot =====
    function renderAllAdminViews(){ renderUnits(); renderAdminLibrary(); renderQuizzes(); renderUsers(); renderExercises(); renderPublicLibrary(); }
    renderAllAdminViews(); applySettingsUI();

    // ===== Analytics =====
    function updateAnalytics(){ $('#statStudents').textContent = users.filter(u=>u.role==='student').length; $('#statTeachers').textContent = users.filter(u=>u.role==='teacher').length; $('#statClasses').textContent = classes.length; $('#statResources').textContent = resources.length; }
    updateAnalytics();
  })();
  </script>
</body>
</html>
