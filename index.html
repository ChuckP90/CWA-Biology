<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CWA-Biology — Bilingual Static Portal (Admin + Public)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; }
    .tab { display:none; }
    .tab.active { display:block; }
    .lang-cn { display:none; }
    section { padding: 3rem 1rem; }
    .dropzone { border:2px dashed #e5e7eb; padding:1rem; border-radius:.5rem; text-align:center; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:.5rem; border:1px solid #e5e7eb; }
    .masked { font-family: monospace; }
    /* small helpers */
    .clickable { cursor:pointer; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Announcement -->
  <div id="globalAnnouncement" class="hidden bg-yellow-100 text-yellow-900 px-6 py-3 text-center"></div>

  <!-- Header -->
  <header id="top-header" class="bg-white shadow sticky top-0 z-50">
    <div class="container mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white font-bold">B</div>
        <h1 id="siteName" class="text-2xl font-bold text-green-700">CWA-Biology</h1>
      </div>
      <nav class="hidden md:flex items-center gap-4">
        <a href="#home" class="nav-link text-gray-700 hover:text-green-600">Home</a>
        <a href="#units" class="nav-link text-gray-700 hover:text-green-600">Units</a>
        <a href="#library" class="nav-link text-gray-700 hover:text-green-600">Library</a>
        <a href="#articles" class="nav-link text-gray-700 hover:text-green-600">Articles</a>
        <a href="#quizzes" class="nav-link text-gray-700 hover:text-green-600">Quizzes</a>
        <a href="#progress" class="nav-link text-gray-700 hover:text-green-600">Progress</a>
        <button id="adminOpenBtn" class="bg-red-600 text-white px-4 py-2 rounded">Admin</button>
        <button id="langToggle" class="border border-green-600 text-green-600 px-3 py-2 rounded">中文</button>
      </nav>
    </div>
  </header>

  <!-- Main content -->
  <main>

    <!-- Home -->
    <section id="home" class="relative flex items-center justify-center bg-gray-800 text-white" style="min-height:36vh">
      <div class="text-center p-6">
        <h2 class="text-3xl md:text-4xl font-bold lang-en">Welcome to CWA-Biology</h2>
        <h2 class="text-3xl md:text-4xl font-bold lang-cn">欢迎来到 CWA-Biology</h2>
        <p class="mt-3 text-lg lang-en">Interactive bilingual biology resource — public portal (Admin can manage content).</p>
        <p class="mt-3 text-lg lang-cn">双语生物资源平台 — 公开门户（管理员可管理内容）。</p>
      </div>
    </section>

    <!-- Units (public view grouped list) -->
    <section id="units" class="bg-gray-100">
      <div class="max-w-5xl mx-auto">
        <h2 class="text-2xl font-semibold mb-4 text-center lang-en">📘 Units</h2>
        <h2 class="text-2xl font-semibold mb-4 text-center lang-cn">📘 单元</h2>

        <div id="unitsList" class="space-y-4"></div>
      </div>
    </section>

    <!-- Library (resources per unit) -->
    <section id="library" class="bg-white">
      <div class="max-w-6xl mx-auto">
        <h2 class="text-2xl font-semibold mb-4 text-center lang-en">📚 Library (Unit-based)</h2>
        <h2 class="text-2xl font-semibold mb-4 text-center lang-cn">📚 资料库（按单元）</h2>
        <div id="libraryList" class="grid md:grid-cols-2 gap-4"></div>
      </div>
    </section>

    <!-- Articles -->
    <section id="articles" class="bg-gray-100">
      <div class="max-w-6xl mx-auto">
        <h2 class="text-2xl font-semibold mb-4 text-center lang-en">📄 Articles</h2>
        <h2 class="text-2xl font-semibold mb-4 text-center lang-cn">📄 文章</h2>
        <div id="articlesList" class="space-y-4"></div>
      </div>
    </section>

    <!-- Quizzes -->
    <section id="quizzes" class="bg-white">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-2xl font-semibold mb-4 text-center lang-en">📝 Quizzes</h2>
        <h2 class="text-2xl font-semibold mb-4 text-center lang-cn">📝 测验</h2>
        <div id="quizzesList" class="space-y-4"></div>
      </div>
    </section>

    <!-- Progress placeholder -->
    <section id="progress" class="bg-gray-100">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-2xl font-semibold mb-4 lang-en">📊 Progress Tracking</h2>
        <h2 class="text-2xl font-semibold mb-4 lang-cn">📊 学习进度</h2>
        <p class="text-gray-600 lang-en">Progress features are placeholders in static mode.</p>
        <p class="text-gray-600 lang-cn">静态模式下，进度功能为占位符。</p>
      </div>
    </section>

    <!-- Admin Dashboard placeholder (shown after login) -->
    <section id="adminDashboardSection" class="bg-white hidden">
      <div class="max-w-7xl mx-auto py-8">
        <h2 class="text-2xl font-semibold text-center mb-6">⚙️ Admin Dashboard</h2>
        <div class="grid md:grid-cols-4 gap-6">
          <aside class="bg-gray-50 p-4 rounded-lg shadow">
            <nav class="space-y-2">
              <button class="admin-tab-btn w-full text-left px-3 py-2 rounded bg-red-600 text-white" data-tab="admin-units">Units</button>
              <button class="admin-tab-btn w-full text-left px-3 py-2 rounded bg-gray-200" data-tab="admin-articles">Articles</button>
              <button class="admin-tab-btn w-full text-left px-3 py-2 rounded bg-gray-200" data-tab="admin-quizzes">Quizzes</button>
              <button id="adminCloseBtn" class="w-full text-left px-3 py-2 rounded bg-gray-200 mt-4">Close Admin</button>
            </nav>
            <div class="mt-6 text-sm text-gray-500">Admin: <strong>Chagri90</strong></div>
          </aside>

          <div class="md:col-span-3">
            <!-- Units Tab -->
            <div id="admin-units" class="admin-tab-panel bg-white p-6 rounded shadow">
              <h3 class="text-lg font-semibold text-red-600 mb-4">Manage Units</h3>
              <form id="unitForm" class="grid gap-3 md:grid-cols-2">
                <input id="u_title" placeholder="Unit title (e.g., Unit 1: Characteristics)" class="border px-3 py-2 rounded" required>
                <input id="u_code" placeholder="Unit code (optional)" class="border px-3 py-2 rounded">
                <textarea id="u_en_orig" placeholder="English Original (full text)" class="border px-3 py-2 rounded md:col-span-2"></textarea>
                <textarea id="u_en_simp" placeholder="English Simplified" class="border px-3 py-2 rounded md:col-span-2"></textarea>
                <textarea id="u_cn_orig" placeholder="中文原文" class="border px-3 py-2 rounded md:col-span-2"></textarea>
                <textarea id="u_cn_simp" placeholder="中文简化版" class="border px-3 py-2 rounded md:col-span-2"></textarea>
                <button class="md:col-span-2 bg-red-600 text-white px-4 py-2 rounded">Add Unit</button>
              </form>
              <div id="adminUnitsList" class="mt-4 space-y-2"></div>
            </div>

            <!-- Articles Tab -->
            <div id="admin-articles" class="admin-tab-panel bg-white p-6 rounded shadow hidden">
              <h3 class="text-lg font-semibold text-red-600 mb-4">Manage Articles</h3>
              <form id="articleForm" class="grid gap-3">
                <select id="article_unit_select" class="border px-3 py-2 rounded" required>
                  <option value="">Select Unit</option>
                </select>
                <input id="a_title" placeholder="Article Title" class="border px-3 py-2 rounded" required>
                <textarea id="a_en_orig" placeholder="English Original (full article)" class="border px-3 py-2 rounded"></textarea>
                <textarea id="a_en_simp" placeholder="English Simplified" class="border px-3 py-2 rounded"></textarea>
                <textarea id="a_cn_orig" placeholder="中文原文" class="border px-3 py-2 rounded"></textarea>
                <textarea id="a_cn_simp" placeholder="中文简化版" class="border px-3 py-2 rounded"></textarea>
                <button class="bg-red-600 text-white px-4 py-2 rounded">Add Article</button>
              </form>
              <div id="adminArticlesList" class="mt-4 space-y-2"></div>
            </div>

            <!-- Quizzes Tab -->
            <div id="admin-quizzes" class="admin-tab-panel bg-white p-6 rounded shadow hidden">
              <h3 class="text-lg font-semibold text-red-600 mb-4">Manage Quizzes</h3>
              <form id="quizForm" class="grid gap-3">
                <select id="quiz_unit_select" class="border px-3 py-2 rounded" required>
                  <option value="">Select Unit</option>
                </select>
                <input id="q_title" placeholder="Quiz title / Question" class="border px-3 py-2 rounded" required>
                <!-- For simplicity we store options as newline-separated pairs including correct marker -->
                <textarea id="q_en_orig" placeholder="English Original options (one per line; prefix correct with *)" class="border px-3 py-2 rounded" ></textarea>
                <textarea id="q_en_simp" placeholder="English Simplified options (one per line; prefix correct with *)" class="border px-3 py-2 rounded" ></textarea>
                <textarea id="q_cn_orig" placeholder="中文原文选项 (每行一个; 正确项前加*)" class="border px-3 py-2 rounded" ></textarea>
                <textarea id="q_cn_simp" placeholder="中文简化版选项 (每行一个; 正确项前加*)" class="border px-3 py-2 rounded" ></textarea>
                <button class="bg-red-600 text-white px-4 py-2 rounded">Add Quiz</button>
              </form>
              <div id="adminQuizzesList" class="mt-4 space-y-2"></div>
            </div>

          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Admin Login Modal -->
  <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded p-6 w-full max-w-md">
      <h3 class="text-xl font-bold mb-3 text-red-600">Admin Login</h3>
      <form id="adminLoginForm" class="space-y-3">
        <input id="adminUser" placeholder="Username" class="w-full border rounded px-3 py-2" required />
        <input id="adminPass" type="password" placeholder="Password" class="w-full border rounded px-3 py-2" required />
        <p id="adminErr" class="text-red-600 hidden"></p>
        <button class="w-full bg-red-600 text-white px-3 py-2 rounded">Login</button>
      </form>
      <button id="closeAdminModal" class="mt-3 text-gray-600">Close</button>
    </div>
  </div>

  <script>
  (function(){
    // --------------------------
    // Utilities & storage helpers
    // --------------------------
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const uid = () => (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2,9));
    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const load = (k,def) => { try { const v = JSON.parse(localStorage.getItem(k)); return v ?? def; } catch { return def; } };

    // storage keys
    const KEY_UNITS = 'cwa_units_v1';
    const KEY_ARTICLES = 'cwa_articles_v1';
    const KEY_QUIZZES = 'cwa_quizzes_v1';
    const KEY_SETTINGS = 'cwa_settings_v1';

    // initial hard-coded Unit 1 and Sample Article & Quiz (hard-coded into HTML view already)
    // but also seed localStorage so Admin additions will merge nicely.
    if(!localStorage.getItem(KEY_UNITS)) {
      const seedUnits = [
        {
          id: 'unit-1',
          title: 'Unit 1: The Characteristics of Living Organisms',
          code: 'UNIT-1',
          en_original: `Living organisms share a set of characteristics that distinguish them from non-living things. These include Movement, Respiration, Sensitivity, Growth, Reproduction, Excretion, and Nutrition.`,
          en_simplified: `Living things are different from non-living things. They move, breathe for energy, respond to changes, grow, reproduce, get rid of waste, and need food.`,
          cn_original: `生物体具有一系列特征，使它们与非生物区分开来：运动、呼吸、感应性、生长、繁殖、排泄和营养。`,
          cn_simplified: `生物和非生物不同。它们会动、呼吸获得能量、对变化作出反应、长大、繁殖、排出废物并且需要食物。`
        }
      ];
      save(KEY_UNITS, seedUnits);
    }

    if(!localStorage.getItem(KEY_ARTICLES)) {
      // Article adapted from GeeksforGeeks (citation included in article object)
      const seedArticles = [
        {
          id: uid(),
          unitId: 'unit-1',
          title: 'Living Things: Characteristics and Examples — Source-based',
          en_original: `All living organisms must show certain key characteristics to be classified as living. These include Movement, Sensitivity, Respiration, Nutrition, and Growth. For example, movement lets animals find food or escape predators; respiration releases chemical energy from food.`,
          en_simplified: `Living things share important features: they move, react to the environment, breathe to get energy, eat, and grow.`,
          cn_original: `所有生物必须表现出若干关键特征才能被归类为有生命的。这些包括运动、感应性、呼吸、营养和生长。例如，运动使动物能够寻找食物或逃避捕食者；呼吸从食物中释放化学能量。 (Adapted from GeeksforGeeks)`,
          cn_simplified: `生物有一些重要特点：会动、会对环境作出反应、会呼吸以获取能量、会吃东西并且会长大。`,
          source: 'https://www.geeksforgeeks.org/characteristics-of-living-things/'
        }
      ];
      save(KEY_ARTICLES, seedArticles);
    }

    if(!localStorage.getItem(KEY_QUIZZES)) {
      const seedQuizzes = [
        {
          id: uid(),
          unitId: 'unit-1',
          title: 'Unit 1 — Basic MCQ',
          en_orig_options: ['Nutrition','Respiration','Excretion (correct)','Growth'],
          en_simp_options: ['Food','Breathing','Excretion (正确)','Growing'],
          cn_orig_options: ['营养','呼吸','排泄 (正确)','生长'],
          cn_simp_options: ['吃东西','呼吸','排泄 (正确)','长大']
        }
      ];
      save(KEY_QUIZZES, seedQuizzes);
    }

    // --------------------------
    // Rendering: public sections
    // --------------------------
    function renderUnitsList(){
      const units = load(KEY_UNITS, []);
      const container = $('#unitsList');
      if(units.length === 0){
        container.innerHTML = `<p class="text-gray-500">No units yet.</p>`;
        return;
      }
      container.innerHTML = units.map(u => `
        <div class="bg-white p-4 rounded shadow">
          <div class="flex justify-between items-start">
            <div>
              <div class="font-semibold text-lg">${escapeHtml(u.title)}</div>
              ${u.code ? `<div class="text-sm text-gray-500">${escapeHtml(u.code)}</div>` : ''}
            </div>
            <div class="text-sm text-gray-500">Unit ID: ${u.id}</div>
          </div>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <div class="bg-gray-50 p-3 rounded">
              <div class="font-medium lang-en">English Original</div>
              <div class="text-sm lang-en">${nl2p(escapeHtml(u.en_original))}</div>
            </div>
            <div class="bg-gray-50 p-3 rounded">
              <div class="font-medium lang-cn">中文原文</div>
              <div class="text-sm lang-cn">${nl2p(escapeHtml(u.cn_original))}</div>
            </div>
            <div class="bg-gray-50 p-3 rounded">
              <div class="font-medium lang-en">English Simplified</div>
              <div class="text-sm lang-en">${nl2p(escapeHtml(u.en_simplified))}</div>
            </div>
            <div class="bg-gray-50 p-3 rounded">
              <div class="font-medium lang-cn">中文简化版</div>
              <div class="text-sm lang-cn">${nl2p(escapeHtml(u.cn_simplified))}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderLibrary(){
      // For simplicity, library shows articles as resources and groups by unit
      const units = load(KEY_UNITS, []);
      const articles = load(KEY_ARTICLES, []);
      const container = $('#libraryList');
      if(units.length === 0){ container.innerHTML = '<p class="text-gray-500">No units.</p>'; return; }
      container.innerHTML = units.map(u => {
        const artForUnit = articles.filter(a=>a.unitId === u.id);
        return `
        <div class="bg-white p-4 rounded shadow">
          <div class="font-semibold">${escapeHtml(u.title)}</div>
          <div class="text-sm text-gray-500 mb-2">Articles & resources for this unit</div>
          ${artForUnit.length ? artForUnit.map(a=>`<div class="border rounded p-2 mb-2">
              <div class="font-medium">${escapeHtml(a.title)}</div>
              <div class="text-xs text-gray-500">Source: ${a.source ? `<a href="${escapeAttr(a.source)}" target="_blank" class="text-blue-600">${escapeHtml(a.source)}</a>` : '—'}</div>
            </div>`).join('') : '<div class="text-gray-500 text-sm">No resources yet for this unit.</div>'}
        </div>
        `;
      }).join('');
    }

    function renderArticles(){
      const articles = load(KEY_ARTICLES, []);
      const container = $('#articlesList');
      if(articles.length === 0){ container.innerHTML = '<p class="text-gray-500">No articles yet.</p>'; return; }
      container.innerHTML = articles.map(a => `
        <div class="bg-white p-4 rounded shadow">
          <div class="flex justify-between items-start">
            <div class="font-semibold">${escapeHtml(a.title)}</div>
            <div class="text-sm text-gray-500">Unit: ${getUnitTitle(a.unitId)}</div>
          </div>
          <div class="mt-3 grid md:grid-cols-2 gap-3">
            <div class="bg-gray-50 p-3 rounded">
              <div class="font-medium lang-en">English Original</div>
              <div class="text-sm lang-en">${nl2p(escapeHtml(a.en_original))}</div>
            </div>
            <div class="bg-gray-50 p-3 rounded">
              <div class="font-medium lang-cn">中文原文</div>
              <div class="text-sm lang-cn">${nl2p(escapeHtml(a.cn_original))}</div>
            </div>
            <div class="bg-white p-3 rounded border">
              <div class="font-medium lang-en">English Simplified</div>
              <div class="text-sm lang-en">${nl2p(escapeHtml(a.en_simplified))}</div>
            </div>
            <div class="bg-white p-3 rounded border">
              <div class="font-medium lang-cn">中文简化版</div>
              <div class="text-sm lang-cn">${nl2p(escapeHtml(a.cn_simplified))}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderQuizzes(){
      const quizzes = load(KEY_QUIZZES, []);
      const container = $('#quizzesList');
      if(quizzes.length === 0){ container.innerHTML = '<p class="text-gray-500">No quizzes yet.</p>'; return; }
      container.innerHTML = quizzes.map(q => `
        <div class="bg-white p-4 rounded shadow">
          <div class="flex justify-between items-start">
            <div class="font-semibold">${escapeHtml(q.title)}</div>
            <div class="text-sm text-gray-500">Unit: ${getUnitTitle(q.unitId)}</div>
          </div>
          <div class="mt-3 space-y-2">
            <div class="p-3 bg-gray-50 rounded">
              <div class="font-medium lang-en">English Original Options</div>
              <ul class="list-disc pl-5 text-sm lang-en">${q.en_orig_options.map(o => `<li>${escapeHtml(o)}</li>`).join('')}</ul>
            </div>
            <div class="p-3 bg-gray-50 rounded">
              <div class="font-medium lang-en">English Simplified Options</div>
              <ul class="list-disc pl-5 text-sm lang-en">${q.en_simp_options.map(o => `<li>${escapeHtml(o)}</li>`).join('')}</ul>
            </div>
            <div class="p-3 bg-white rounded border">
              <div class="font-medium lang-cn">中文原文选项</div>
              <ul class="list-disc pl-5 text-sm lang-cn">${q.cn_orig_options.map(o => `<li>${escapeHtml(o)}</li>`).join('')}</ul>
            </div>
            <div class="p-3 bg-white rounded border">
              <div class="font-medium lang-cn">中文简化版选项</div>
              <ul class="list-disc pl-5 text-sm lang-cn">${q.cn_simp_options.map(o => `<li>${escapeHtml(o)}</li>`).join('')}</ul>
            </div>
          </div>
        </div>
      `).join('');
    }

    // --------------------------
    // Admin: populate unit dropdowns & admin lists
    // --------------------------
    function refreshAdminUnitSelectors(){
      const units = load(KEY_UNITS, []);
      const selA = $('#article_unit_select');
      const selQ = $('#quiz_unit_select');
      selA.innerHTML = `<option value="">Select Unit</option>` + units.map(u=>`<option value="${u.id}">${escapeHtml(u.title)}</option>`).join('');
      selQ.innerHTML = `<option value="">Select Unit</option>` + units.map(u=>`<option value="${u.id}">${escapeHtml(u.title)}</option>`).join('');
    }

    function renderAdminUnitsList(){
      const units = load(KEY_UNITS, []);
      const container = $('#adminUnitsList');
      container.innerHTML = units.map(u=>`
        <div class="flex items-start justify-between p-2 border rounded">
          <div><div class="font-semibold">${escapeHtml(u.title)}</div><div class="text-sm text-gray-500">${escapeHtml(u.code||'')}</div></div>
          <div class="flex gap-2">
            <button class="edit-unit text-blue-600" data-id="${u.id}">Edit</button>
            <button class="del-unit text-red-600" data-id="${u.id}">Delete</button>
          </div>
        </div>
      `).join('') || '<p class="text-gray-500">No units.</p>';
      // attach listeners
      $$('.del-unit').forEach(btn => btn.addEventListener('click', () => {
        if(confirm('Delete this unit?')) {
          let units = load(KEY_UNITS, []);
          units = units.filter(x=>x.id !== btn.dataset.id);
          save(KEY_UNITS, units);
          // also remove related articles/quizzes
          let arts = load(KEY_ARTICLES, []);
          arts = arts.filter(a=>a.unitId !== btn.dataset.id); save(KEY_ARTICLES, arts);
          let qus = load(KEY_QUIZZES, []);
          qus = qus.filter(q=>q.unitId !== btn.dataset.id); save(KEY_QUIZZES, qus);
          updateAllViews();
        }
      }));
      $$('.edit-unit').forEach(btn => btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        let units = load(KEY_UNITS, []);
        const u = units.find(x=>x.id===id);
        if(!u) return;
        const title = prompt('Edit unit title', u.title);
        if(title !== null) { u.title = title; save(KEY_UNITS, units); updateAllViews(); }
      }));
    }

    function renderAdminArticlesList(){
      const arts = load(KEY_ARTICLES, []);
      const container = $('#adminArticlesList');
      container.innerHTML = arts.map(a=>`
        <div class="flex items-start justify-between p-2 border rounded">
          <div><div class="font-semibold">${escapeHtml(a.title)}</div><div class="text-sm text-gray-500">Unit: ${getUnitTitle(a.unitId)}</div></div>
          <div class="flex gap-2">
            <button class="edit-article text-blue-600" data-id="${a.id}">Edit</button>
            <button class="del-article text-red-600" data-id="${a.id}">Delete</button>
          </div>
        </div>
      `).join('') || '<p class="text-gray-500">No articles.</p>';
      $$('.del-article').forEach(btn => btn.addEventListener('click', ()=> {
        if(confirm('Delete this article?')) {
          let arts = load(KEY_ARTICLES, []); arts = arts.filter(x=>x.id !== btn.dataset.id); save(KEY_ARTICLES, arts); updateAllViews();
        }
      }));
      $$('.edit-article').forEach(btn => btn.addEventListener('click', ()=> {
        const id = btn.dataset.id; let arts = load(KEY_ARTICLES, []); const a = arts.find(x=>x.id===id); if(!a) return;
        const title = prompt('Edit title', a.title); if(title !== null) { a.title = title; save(KEY_ARTICLES, arts); updateAllViews(); }
      }));
    }

    function renderAdminQuizzesList(){
      const qus = load(KEY_QUIZZES, []);
      const container = $('#adminQuizzesList');
      container.innerHTML = qus.map(q=>`
        <div class="flex items-start justify-between p-2 border rounded">
          <div><div class="font-semibold">${escapeHtml(q.title)}</div><div class="text-sm text-gray-500">Unit: ${getUnitTitle(q.unitId)}</div></div>
          <div class="flex gap-2">
            <button class="edit-quiz text-blue-600" data-id="${q.id}">Edit</button>
            <button class="del-quiz text-red-600" data-id="${q.id}">Delete</button>
          </div>
        </div>
      `).join('') || '<p class="text-gray-500">No quizzes.</p>';
      $$('.del-quiz').forEach(btn => btn.addEventListener('click', ()=> {
        if(confirm('Delete this quiz?')) {
          let qus = load(KEY_QUIZZES, []); qus = qus.filter(x=>x.id !== btn.dataset.id); save(KEY_QUIZZES, qus); updateAllViews();
        }
      }));
    }

    // --------------------------
    // Helpers
    // --------------------------
    function getUnitTitle(id){
      const units = load(KEY_UNITS, []);
      const u = units.find(x=>x.id === id);
      return u ? u.title : '—';
    }
    function nl2p(text){
      if(!text) return '';
      return text.split('\n').map(l => `<p>${l}</p>`).join('');
    }
    function escapeHtml(s){
      if(!s) return '';
      return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // --------------------------
    // Admin wiring (forms)
    // --------------------------
    $('#unitForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const units = load(KEY_UNITS, []);
      const u = {
        id: uid(),
        title: $('#u_title').value.trim(),
        code: $('#u_code').value.trim(),
        en_original: $('#u_en_orig').value.trim(),
        en_simplified: $('#u_en_simp').value.trim(),
        cn_original: $('#u_cn_orig').value.trim(),
        cn_simplified: $('#u_cn_simp').value.trim()
      };
      units.push(u); save(KEY_UNITS, units);
      $('#u_title').value=''; $('#u_code').value=''; $('#u_en_orig').value=''; $('#u_en_simp').value=''; $('#u_cn_orig').value=''; $('#u_cn_simp').value='';
      updateAllViews();
      alert('Unit added locally (stored in this browser).');
    });

    $('#articleForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const arts = load(KEY_ARTICLES, []);
      const a = {
        id: uid(),
        unitId: $('#article_unit_select').value,
        title: $('#a_title').value.trim(),
        en_original: $('#a_en_orig').value.trim(),
        en_simplified: $('#a_en_simp').value.trim(),
        cn_original: $('#a_cn_orig').value.trim(),
        cn_simplified: $('#a_cn_simp').value.trim(),
        source: '' // optional
      };
      if(!a.unitId){ alert('Please select a unit.'); return; }
      arts.push(a); save(KEY_ARTICLES, arts);
      $('#a_title').value=''; $('#a_en_orig').value=''; $('#a_en_simp').value=''; $('#a_cn_orig').value=''; $('#a_cn_simp').value='';
      updateAllViews();
      alert('Article added locally.');
    });

    $('#quizForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const qus = load(KEY_QUIZZES, []);
      const q = {
        id: uid(),
        unitId: $('#quiz_unit_select').value,
        title: $('#q_title').value.trim(),
        en_orig_options: parseOptions($('#q_en_orig').value),
        en_simp_options: parseOptions($('#q_en_simp').value),
        cn_orig_options: parseOptions($('#q_cn_orig').value),
        cn_simp_options: parseOptions($('#q_cn_simp').value)
      };
      if(!q.unitId){ alert('Please select a unit.'); return; }
      qus.push(q); save(KEY_QUIZZES, qus);
      $('#q_title').value=''; $('#q_en_orig').value=''; $('#q_en_simp').value=''; $('#q_cn_orig').value=''; $('#q_cn_simp').value='';
      updateAllViews();
      alert('Quiz added locally.');
    });

    function parseOptions(text){
      // split lines, treat lines starting with * as correct marked but keep text
      return text.split('\n').map(l=>l.trim()).filter(Boolean);
    }

    // --------------------------
    // Admin tab navigation & open/close
    // --------------------------
    $$('.admin-tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        $$('.admin-tab-btn').forEach(b => { b.classList.remove('bg-red-600','text-white'); b.classList.add('bg-gray-200'); });
        btn.classList.add('bg-red-600','text-white');
        $$('.admin-tab-panel').forEach(p => p.classList.add('hidden'));
        $('#' + tab).classList.remove('hidden');
      });
    });

    $('#adminOpenBtn').addEventListener('click', ()=> $('#adminLoginModal').classList.remove('hidden'));
    $('#closeAdminModal').addEventListener('click', ()=> $('#adminLoginModal').classList.add('hidden'));
    $('#adminCloseBtn').addEventListener('click', ()=> { $('#adminDashboardSection').classList.add('hidden'); window.scrollTo({top:0, behavior:'smooth'}); });

    // Admin login logic (client-side only)
    $('#adminLoginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const u = $('#adminUser').value.trim();
      const p = $('#adminPass').value;
      if(u === 'Chagri90' && p === 'CWA2025BIO'){
        $('#adminLoginModal').classList.add('hidden');
        $('#adminDashboardSection').classList.remove('hidden');
        // initialize admin UI
        refreshAdminUnitSelectors();
        renderAdminUnitsList(); renderAdminArticlesList(); renderAdminQuizzesList();
        // set default admin tab
        $$('.admin-tab-btn')[0].click();
        updateAllViews(); // ensure public view reflects state
        // scroll to admin dashboard
        document.getElementById('adminDashboardSection').scrollIntoView({behavior:'smooth'});
      } else {
        $('#adminErr').classList.remove('hidden'); $('#adminErr').textContent = 'Invalid admin credentials';
      }
    });

    // --------------------------
    // Language toggle
    // --------------------------
    const langToggle = $('#langToggle');
    langToggle.addEventListener('click', () => {
      const showingCn = langToggle.textContent === 'EN';
      $$('.lang-en').forEach(el => el.style.display = showingCn ? 'none' : 'block');
      $$('.lang-cn').forEach(el => el.style.display = showingCn ? 'block' : 'none');
      langToggle.textContent = showingCn ? '中文' : 'EN';
    });

    // --------------------------
    // Update all views (renderers)
    // --------------------------
    function updateAllViews(){
      renderUnitsList();
      renderLibrary();
      renderArticles();
      renderQuizzes();
      refreshAdminUnitSelectors();
      renderAdminUnitsList();
      renderAdminArticlesList();
      renderAdminQuizzesList();
    }

    // initial render
    updateAllViews();

    // --------------------------
    // small helpers: escape for innerHTML etc.
    // --------------------------
    function ensureSeeded() {
      // left as placeholder if future migration needed
    }

    // expose updateAllViews for console debugging
    window.updateCwaViews = updateAllViews;

  })();
  </script>

  <!-- Footer / citation -->
  <footer class="bg-white border-t mt-8">
    <div class="max-w-6xl mx-auto p-6 text-sm text-gray-600">
      <div>Sample article adapted from: GeeksforGeeks — "Characteristics of Living Things". Source: <a href="https://www.geeksforgeeks.org/characteristics-of-living-things/" target="_blank" class="text-blue-600">geeksforgeeks.org</a></div>
      <div class="mt-2">Note: This portal is static & stores admin changes in your browser <strong>localStorage</strong>. To make content persistent across devices/users you must connect to a backend (Supabase/Firebase) — I can help with that next.</div>
    </div>
  </footer>

</body>
</html>
